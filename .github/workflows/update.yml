name: æ•°æ®ä»“åº“æ›´æ–°æµæ°´çº¿

on:
  workflow_dispatch:
    inputs:
      debug:
        type: boolean
        description: 'debug'
        required: false
        default: false

env:
  UNITY_ASSETS_REPO: 'SeerAPI/seer-unity-assets'
  CONFIG_SOURCE_REPO: 'SeerAPI/config-sources'

permissions:
  contents: write

jobs:
  update-unity-assets:
    runs-on: ubuntu-latest
    outputs:
      has_update: ${{ steps.update.outputs.has_update }}

    steps:
      - name: æ£€å‡ºè„šæœ¬ä»“åº“
        uses: actions/checkout@v4

      - name: è®¾ç½® Python ç¯å¢ƒ
        uses: ./.github/actions/setup-environment
        with:
          python-version: '3.10'
          install-dependencies: 'true'

      - name: æ£€æŸ¥æ›´æ–°
        id: check-update
        run: |
          echo "ğŸš€ å¼€å§‹æ£€æŸ¥æ›´æ–°..."
          uv run check-seer-assets ${{ env.UNITY_ASSETS_REPO }} main
          echo "âœ… æ£€æŸ¥æ›´æ–°å®Œæˆ"

      - name: æ£€å‡ºä»“åº“
        id: checkout-repo
        uses: ./.github/actions/checkout-repo
        if: steps.check-update.outputs.need_update == 'true'
        with:
          ssh-key: ${{ secrets.SSH_PRIVATE_KEY }}
          repository: ${{ env.UNITY_ASSETS_REPO }}
          path: 'seer-unity-assets'
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 1

      - name: æ›´æ–° seer-unity-assets
        id: update
        working-directory: ${{ steps.checkout-repo.outputs.repo-path }}
        if: steps.check-update.outputs.need_update == 'true'
        run: |
          echo "ğŸš€ å¼€å§‹å¤„ç†æ•°æ®..."
          uv run update-seer-assets
          echo "âœ… æ•°æ®å¤„ç†å®Œæˆ"

  update-config-sources:
    runs-on: ubuntu-latest
    needs: update-unity-assets
    if: ${{ needs.update-unity-assets.outputs.has_update == 'true' || inputs.debug }}

    steps:
      - name: æ£€å‡ºè„šæœ¬ä»“åº“
        uses: actions/checkout@v4

      - name: è®¾ç½® Python ç¯å¢ƒ
        uses: ./.github/actions/setup-environment
        with:
          python-version: '3.10'
          install-dependencies: 'true'

      - name: æ£€å‡ºä»“åº“
        id: checkout-repo
        uses: ./.github/actions/checkout-repo
        with:
          # ssh-key: ${{ secrets.SSH_PRIVATE_KEY }}
          repository: ${{ env.CONFIG_SOURCE_REPO }}
          path: 'config-sources'
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 1

      - name: è¿è¡Œæ•°æ®å¤„ç†
        id: update
        working-directory: ${{ steps.checkout-repo.outputs.repo-path }}
        run: |
          echo "ğŸš€ å¼€å§‹å¤„ç†æ•°æ®..."
          uv run update-config-sources
          echo "âœ… æ•°æ®å¤„ç†å®Œæˆ"
      
      - name: Repository Dispatch
        uses: peter-evans/repository-dispatch@v4
        if: steps.update.outputs.has_update == 'true'
        with:
          token: ${{ secrets.PAT }}
          repository: seerapi/api-data
          event-type: config-source-update
